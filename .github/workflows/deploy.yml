name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Create deployment structure
        run: |
          echo "üöÄ Creating deployment structure for GitHub Pages..."
          
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É –¥–ª—è —Å–±–æ—Ä–∫–∏
          mkdir -p temp-deploy
          echo "‚úÖ Created temp-deploy directory"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ø–µ—Ä–µ–¥ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º
          echo "üìÅ Checking source files..."
          
          if [ ! -f "index.html" ]; then
            echo "‚ùå ERROR: index.html not found!"
            exit 1
          fi
          
          if [ ! -d "assets" ]; then
            echo "‚ùå ERROR: assets directory not found!"
            exit 1
          fi
          
          if [ ! -d "pages" ]; then
            echo "‚ùå ERROR: pages directory not found!"
            exit 1
          fi
          
          echo "‚úÖ All source files found"
          
          # –ö–æ–ø–∏—Ä—É–µ–º index.html –≤ –∫–æ—Ä–µ–Ω—å
          cp index.html temp-deploy/
          echo "‚úÖ Copied index.html"
          
          # –ö–æ–ø–∏—Ä—É–µ–º –ø–∞–ø–∫—É assets
          cp -r assets temp-deploy/
          echo "‚úÖ Copied assets directory"
          
          # –ö–æ–ø–∏—Ä—É–µ–º HTML —Ñ–∞–π–ª—ã –∏–∑ pages/ –≤ –∫–æ—Ä–µ–Ω—å
          cp pages/*.html temp-deploy/
          echo "‚úÖ Copied pages/*.html"
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
          echo "üìÇ Deployment structure created:"
          ls -la temp-deploy/
          echo "üìÇ Assets structure:"
          ls -la temp-deploy/assets/
          echo "üìÇ JS files:"
          ls -la temp-deploy/assets/js/
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –ø—É—Ç–∏ –≤ HTML —Ñ–∞–π–ª–∞—Ö –¥–ª—è GitHub Pages
          echo "üîß Updating paths in HTML files..."
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –ø—É—Ç–∏ –≤ index.html
          sed -i 's|assets/|assets/|g' temp-deploy/index.html
          echo "‚úÖ Updated paths in index.html"
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –ø—É—Ç–∏ –≤ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö HTML —Ñ–∞–π–ª–∞—Ö
          for file in temp-deploy/*.html; do
            if [ "$(basename "$file")" != "index.html" ]; then
              echo "üîß Processing file: $(basename "$file")"
              # –ó–∞–º–µ–Ω—è–µ–º ../assets/ –Ω–∞ assets/ –¥–ª—è —Ñ–∞–π–ª–æ–≤ –∏–∑ pages/
              sed -i 's|../assets/|assets/|g' "$file"
              # –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –º–µ–∂–¥—É —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏
              sed -i 's|pages/||g' "$file"
              echo "‚úÖ Updated paths in $(basename "$file")"
            fi
          done
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –≤ JS —Ñ–∞–π–ª–∞—Ö (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è)
          echo "üîß Updating navigation in JS files..."
          if [ -d "temp-deploy/assets/js" ]; then
            for file in temp-deploy/assets/js/*.js; do
              if [ -f "$file" ]; then
                echo "üîß Processing JS file: $(basename "$file")"
                # –ó–∞–º–µ–Ω—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –Ω–∞ pages/ –Ω–∞ –ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏
                sed -i 's|pages/||g' "$file"
                # –ó–∞–º–µ–Ω—è–µ–º ../index.html –Ω–∞ index.html
                sed -i 's|../index.html|index.html|g' "$file"
                echo "‚úÖ Updated navigation in $(basename "$file")"
              fi
            done
          else
            echo "‚ö†Ô∏è Warning: temp-deploy/assets/js directory not found"
          fi
          
          echo "üéâ Deployment structure created successfully!"
          
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./temp-deploy
          force_orphan: true
          
      - name: Cleanup
        run: |
          echo "üßπ Cleaning up temporary files..."
          rm -rf temp-deploy
          echo "‚úÖ Cleanup completed"
          
      - name: Success message
        run: |
          echo "üéâ Deployment completed successfully!"
          echo "üåê Your Telegram Mini App is now available at:"
          echo "https://${{ github.repository_owner }}.github.io/$(echo ${{ github.repository }} | cut -d'/' -f2)/"
          echo "üì± Ready for Telegram Mini App integration!" 